<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Demo</title>  
    <style>
        video {
            border:5px solid steelblue;
            width:400px;
            height:300px;
        }
        button {
            font: 18px sans-serif;
            padding: 8px;
        }
    </style>
</head>
<body onload="initialize();">
    <video id="localVideo" autoplay="true" style="width:160px; height:120px;"></video>
    <video id="localScreen" autoplay="true" style="width:160px; height:120px;"></video>
    <video id="remoteVideo" autoplay="true" style="margin-left:5px;width:160px;height:120px"></video>
    <video id="remoteScreen" autoplay="true" style="margin-left:5px;width:160px;height:120px"></video>

    <p></p>
    <button type="button" onclick="startVideo();">Pick my Video</button>
    <button type="button" onclick="callVideo();">VideoCall a Peer</button>
    <button type="button" onclick="removeVideoToCall();">Remove Video</button>
    <button type="button" onclick="addVideoToCall();">Add Video</button>
    <button type="button" onclick="stopVideo();">Stop Video</button>
    <br>
    <button type="button" onclick="share();">Pick my Screen</button>
    <button type="button" onclick="callScreen();">ScreenCall a Peer</button>
    <button type="button" onclick="endScreen();">Stop Screen</button>
    <br>
    <button type="button" onclick="mute();">Mute</button>
    <button type="button" onclick="unmute();">Unmute</button>
    <br>
    <button type="button" onclick="stopCall();">Release Call</button>
    <br>
    <button type="button" onclick="stats();">Stats</button>
    <button type="button" onclick="stopStats();">Stop Stats</button>
    <br>

    <button type="button" onclick="call2();">Call 2nd Peer</button>
    <button type="button" onclick="call3();">Call 3rd Peer</button>
    <button type="button" onclick="broadcast();">Call all Peers</button>
    <button type="button" onclick="sendAMessage();">SendMessage</button>
    <footer id="footer">
    </footer>
    <script type="text/javascript" src="dist/sonotone.js"></script>

    <script>

        var sono;

        var users = [];

        var isSharing = false;
        var isVideo = false;

        var bytesNow, bytesPrev = 0;
        var timestampPrev;
        var answerID = '';

        function initialize() {

            // Define your Sonotone settings
            Sonotone.debug = true;
            Sonotone.enableSTUN = false;

            // Create your Sonotone
            sono = new Sonotone.IO(new Date().getTime().toString());

            // Listen to peers
            sono.on('onPeerConnected', onPeerConnected, this);
            sono.on('onPeerAlreadyConnected', onPeerConnected, this);
            sono.on('onPeerDisconnected', onPeerDisconnected, this);

            // Listen to call
            sono.on('onCallOffered', onCallOffered, this);
            sono.on('onCallAnswered', onCallAnswered, this);
            sono.on('onCallStarted', onCallStarted, this);
            sono.on('onCallEnded', onCallEnded, this);

            // Listen to transport event
            sono.on('onTransportReady', onTransportReady, this);
            sono.off('onTransportReady', onTransportReady);

            sono.on('onTransportClose', onTransportClose, this);
            sono.on('onTransportMessage', onTransportMessage, this);
            sono.on('onTransportError', onTransportError, this);

            // Listen to statistics
            sono.on('onPeerConnectionStats', onStats, this);
            
            // Listen to local Media
            sono.localMedia().on('onLocalVideoStreamStarted', onLocalStreamStarted, this);
            sono.localMedia().on('onLocalScreenStreamStarted', onLocalScreenStreamStarted, this);
            sono.localMedia().on('onLocalVideoStreamEnded', onLocalStreamEnded, this);
            sono.localMedia().on('onLocalScreenStreamEnded', onLocalScreenStreamEnded, this);

            // Listen to remote media
            sono.localMedia().on('onLocalVideoStreamError', onLocalStreamError, this);
            sono.remoteMedia().on('onRemoteStreamStarted', onRemoteStreamStarted, this);
            sono.remoteMedia().on('onRemoteStreamEnded', onRemoteStreamEnded, this);

            // Define your transport layer (WebSocket)
            sono.transport('websocket', {host: '192.168.0.126', port: '1337'}).connect({});

        };

/* --------------- Features ---------------- */

        function startVideo() {

            var constraints = {
                audio: true,
                video: true,
                format: 'hd'
            };

            sono.localMedia().acquire(constraints);
        };

        function stopVideo() {
            var id = users[0].id;
            console.log("coucou");
            sono.release(id, 'video');
        };

        function endSCreen() {
          sono.releaseScreen();
        }

        function callVideo() {
          var id = users[0].id;
            sono.call(id, 'video', false);
        };

        function addVideoToCall() {
          var id = users[0].id;
          sono.addVideoToCall(id);
        }

        function removeVideoToCall() {
         var id = users[0].id;
          sono.removeVideoFromCall(id); 
        }

        function callScreen() {
          var id = users[0].id;
            sono.call(id, 'screen', false);
        }

        function call2() {
            sono.call(users[1].id);
        };

        function call3() {
            sono.call(users[2].id);
        };

        function broadcast() {
            sono.broadcastCall(users);
        };

        function sendAMessage() {
            sono.sendMessage(
                {
                    data: {
                        msg: new Date().getTime().toString(), 
                        type: 'data'
                    }, 
                    recipient: 'all'
                }
            );
        };

        function share() {
            
            sono.localMedia().acquireScreen();
        };

        function stats() {
            sono.setStats();
        };

        function stopStats() {
            sono.stopStats();
        };

        function mute() {
            document.getElementById('localVideo').setAttribute('muted', 'muted');
            sono.mute(users[0].id, true, true);
        };

        function unmute() {
            document.getElementById('localVideo').removeAttribute('muted');
            sono.unmute(users[0].id, true, true);
        };

/* --------------- Callbacks ------------------ */

        function onTransportReady() {
            console.log("Transport ready");
        };

        function onTransportClose() {
            console.log("Transport closed");
        };

        function onTransportMessage(msg) {
            console.log("Transport message", msg);
        };

        function onTransportError(msg) {
            console.log("Transport error", msg);
        };

        function onPeerConnected(user) {
            users.push(user);
            console.log("New User:" + user.id + " (" + users.length + " connected users)");
        };

        function onCallOffered(msg) {
            console.log("REceived call from  with", msg.id, msg.media);
            sono.answer(msg.id);  
        };

        function onCallAnswered(fromID) {
        };

        function onCallStarted(fromID) {
        };

        function onCallEnded(fromID) {
            document.getElementById('remoteVideo').src = '';
        };

        function onPeerDisconnected(msg) {
            console.log("User to remove: ", msg.id);
            var indexToRemove = -1;

            for (var i=0; i < users.length; i++) {
                if(users[i].id === msg.id) {
                    indexToRemove = i;
                }
            }
            if(indexToRemove > -1) {
                var removed = users.splice(indexToRemove, 1);
                removed = null;
            }
            console.log(users.length + " users remains");
        };

        function onLocalStreamStarted(stream) {
            sono.localMedia().renderVideoStream(document.getElementById('localVideo'));
            isVideo = true;
        };

        function onLocalScreenStreamStarted(stream) {
            sono.localMedia().renderScreenStream(document.getElementById('localScreen'));
            isSharing = true;
        }

        function onLocalStreamEnded() {
            document.getElementById('localVideo').src = '';
            isVideo = false;
        };

        function onLocalScreenStreamEnded() {
            document.getElementById('localScreen').src = '';
            isSharing = false;
        }

        function onLocalStreamError(err) {
            // can't get local stream
        };

        function onRemoteStreamStarted(msg) {
            if(msg.media === "video") {
              sono.remoteMedia().renderStream(document.getElementById('remoteVideo'), msg.id, msg.media);  
            }
            else {
              sono.remoteMedia().renderStream(document.getElementById('remoteScreen'), msg.id, msg.media);   
            }
        };

        function onRemoteStreamEnded(msg) {
            if(msg.media === 'video') {
              document.getElementById('remoteVideo').src = '';
            }
            else {
              document.getElementById('remoteScreen').src = ''; 
            }
        };        

        function onErrorReceived(error) {
        };

        

        function onStats(event) {
            console.log("STATS:", event);
            
        }
    </script>
</body>
</html>