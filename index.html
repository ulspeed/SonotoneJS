<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Demo</title>  
    <style>
        video {
            border:5px solid steelblue;
            width:400px;
            height:300px;
        }
        button {
            font: 18px sans-serif;
            padding: 8px;
        }
    </style>
</head>
<body onload="initialize();">
    <video id="localVideo" autoplay="true" style="width:320px; height:240px;"></video>
    <video id="remoteVideo" autoplay="true" style="margin-left:5px;width:600px;height:480px"></video>
    <p></p>
    <button type="button" onclick="startVideo();">Pick my Video</button>
    <button type="button" onclick="share();">Share my Screen</button>
    <button type="button" onclick="call();">Call a Peer</button>
    <button type="button" onclick="call2();">Call 2nd Peer</button>
    <button type="button" onclick="call3();">Call 3rd Peer</button>
    <button type="button" onclick="broadcast();">Call all Peers</button>
    <button type="button" onclick="stopVideo();">Release Call</button>
    <button type="button" onclick="sendAMessage();">SendMessage</button>
    <button type="button" onclick="stats();">Stats</button>
    <button type="button" onclick="stopStats();">Stop Stats</button>

    <footer id="footer">
    </footer>
    <script type="text/javascript" src="dist/sonotone.js"></script>

    <script>

        var sono;

        var users = [];

        var isSharing = false;

        var bytesNow, bytesPrev = 0;
        var timestampPrev;
        var answerID = '';

        function initialize() {

            Sonotone.debug = true;
            Sonotone.enableSTUN = false;

            sono = new Sonotone.IO(new Date().getTime());

            sono.transport('websocket', {host: '192.168.0.126', port: '1337'}).connect();
            //sono.transport('websocket', {host: '172.26.165.49', port: '1337'}).connect();
            //sono.transport('websocket', {host: 'localhost', port: '1337'}).connect();

            sono.on('onPeerConnected', onPeerConnected, this);
            sono.on('onPeerAlreadyConnected', onPeerConnected, this);
            sono.on('onPeerDisconnected', onPeerDisconnected, this);
            sono.on('onCallOffered', onCallOffered, this);
            sono.on('onCallAnswered', onCallAnswered, this);
            sono.on('onCallStarted', onCallStarted, this);
            sono.on('onCallEnded', onCallEnded, this);

            sono.on('onPeerConnectionStats', onStats, this);
            
            sono.localMedia().on('onLocalVideoStreamStarted', onLocalStreamStarted, this);
            sono.localMedia().on('onLocalVideoStreamEnded', onLocalStreamEnded, this);
            sono.localMedia().on('onLocalVideoStreamError', onLocalStreamError, this);
            sono.remoteMedia().on('onRemoteStreamStarted', onRemoteStreamStarted, this);
            sono.remoteMedia().on('onRemoteStreamEnded', onRemoteStreamEnded, this);
        };

        function startVideo() {

            var constraints = {
                audio: false,
                video: true,
                format: 'hd'
            };

            sono.localMedia().acquire(constraints);
        };

        function stopVideo() {
            sono.releaseCall();
        };

        function onPeerConnected(user) {
            users.push(user);
        };

        function onCallOffered(fromID) {
            console.log("fromID=" + fromID);
            sono.answer(fromID);
        };

        function onCallAnswered(fromID) {
        };

        function onCallStarted(fromID) {
        };

        function onCallEnded(fromID) {
            document.getElementById('remoteVideo').src = '';
        };

        function onPeerDisconnected(id) {
        };

        function onLocalStreamStarted(stream) {
            if( !isSharing) {
                sono.localMedia().renderVideoStream(document.getElementById('localVideo'));
            }
        };

        function onLocalStreamEnded() {
            document.getElementById('localVideo').src = '';
        };

        function onLocalStreamError(err) {
            // can't get local stream
        };

        function onRemoteStreamStarted(id) {
            sono.remoteMedia().renderStream(document.getElementById('remoteVideo'), id);
        };

        function onRemoteStreamEnded() {
            document.getElementById('remoteVideo').src = '';
        };        

        function onErrorReceived(error) {
        };

        function call() {
            sono.call(users[0].id);
        };

        function call2() {
            sono.call(users[1].id);
        };

        function call3() {
            sono.call(users[2].id);
        };

        function broadcast() {
            sono.broadcastCall(users);
        };

        function sendAMessage() {
            sono.sendMessage(
                {
                    data: {
                        msg: new Date().getTime().toString(), 
                        type: 'data'
                    }, 
                    recipient: 'all'
                }
            );
        };

        function share() {
            isSharing = true;
            sono.localMedia().acquireScreen();
        };

        function stats() {
            console.log("Statss for ", users[0].id);
            sono.setStats(users[0].id);
            
        };

        function stopStats() {
            sono.stopStats(users[0].id);
        };

        function onStats(event) {

            stats = new AugumentedStatsResponse(event.raw);
            var statsString = '';
            var results = stats.result();

            for (var i = 0; i < results.length; ++i) {
                var res = results[i];
  //              console.log("res.type=" + res.type);
                if (res.type == 'ssrc') {

                    bytesNow = res.stat('bytesReceived') || res.stat('bytesSent');
                    
                    if (timestampPrev > 0) {
                        var bitRate = Math.round((bytesNow - bytesPrev) /
                             (res.timestamp - timestampPrev));
                        console.log(bitRate + ' KB/sec');
                    }
                    timestampPrev = res.timestamp;
                    bytesPrev = bytesNow;

                    if (res.names) {
                        names = res.names();
                        for (var i = 0; i < names.length; ++i) {
                            //console.log("GET " + names[i] + " VALUE " + res.stat(names[i]));
                        }
                    }
                    // This is the video flow.
                    //videoFlowInfo = extractVideoFlowInfo(res, stats);
                }
                //console.log("GET STATS " + i, res);

            }
        }

        // Augumentation of stats entries with utility functions.
        // The augumented entry does what the stats entry does, but adds
        // utility functions.
        function AugumentedStatsResponse(response) {
          this.response = response;
          this.addressPairMap = [];
        }

        AugumentedStatsResponse.prototype.collectAddressPairs = function(componentId) {
          if (!this.addressPairMap[componentId]) {
            this.addressPairMap[componentId] = [];
            for (var i = 0; i < this.response.result().length; ++i) {
              var res = this.response.result()[i];
              if (res.type == 'googCandidatePair' &&
                  res.stat('googChannelId') == componentId) {
                this.addressPairMap[componentId].push(res);
              }
            }
          }
          return this.addressPairMap[componentId];
        }

        AugumentedStatsResponse.prototype.result = function() {
          return this.response.result();
        }

        // The indexed getter isn't easy to prototype.
        AugumentedStatsResponse.prototype.get = function(key) {
          return this.response[key];
        }


    </script>
</body>
</html>